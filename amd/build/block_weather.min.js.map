{"version":3,"sources":["../src/block_weather.js"],"names":["define","$","AJAX","str","mdlcfg","notification","templates","weather","init","enabledOption","weatherKey","get_strings","component","done","s","weatherError","weatherInfo","document","on","tag","html","tempValue","attr","tempAction","farhValue","Math","floor","parseInt","temp","tempData","celcValue","navigator","geolocation","getCurrentPosition","setPosition","showError","position","latitude","coords","longitude","length","openWeather","accuWeather","errorMsg","error","message","context","weathererror","weathericon","M","util","image_url","weathervalue","weatherattr","render","then","fail","exception","api","fetch","response","json","data","cod","main","weatherdesc","description","icon","weatherlocation","name","sys","country","locationKey","console","log","Key","weatherData","WeatherText","Temperature","Metric","Value","WeatherIcon","EnglishName","AdministrativeArea"],"mappings":"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","sourcesContent":["/**\n * Contains the logic for a weather block.\n *\n * @package     block_weather\n * @copyright   2020 A K M Safat Shahin <safatshahin@gmail.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/ajax', 'core/str', 'core/config', 'core/notification', 'core/templates'],\n    function($, AJAX, str, mdlcfg, notification, templates) {\n        var weather = {\n            init: function(enabledOption, weatherKey) {\n                str.get_strings([\n                    {'key': 'no_geo_location_support', component: 'block_weather'},\n                    {'key': 'no_openweather_key', component: 'block_weather'},\n                    {'key': 'no_weather_provider', component: 'block_weather'}\n                ]).done(function(s) {\n                    if (enabledOption === 0) {\n                        weather.weatherError(s[2]);\n                    } else {\n                        weather.weatherInfo(s, enabledOption, weatherKey);\n                    }\n                    // REFRESH THE WEATHER\n                    $(document).on('click', '.block-weather-refresh', function() {\n                        var tag = $('#weather-container');\n                        var html = '';\n                        tag.html(html);\n                        weather.weatherInfo(s, enabledOption, weatherKey);\n                    });\n                    // CHANGE CELSIUS TO FAHRENHEIT ON CLICK OR VICE THE OTHER WAY\n                    $(document).on('click', '.block-weather-temperature-value', function() {\n                        var tempValue = $('.block-weather-temperature-value').attr('data-value');\n                        if (tempValue !== '-') {\n                            var tempAction = $('.block-weather-temperature-value').attr('data-action');\n                            if (tempAction === 'celsius') {\n                                // CHANGE TO FAHRENHEIT\n                                var farhValue = Math.floor((parseInt(tempValue) * 9 / 5) + 32);\n                                var temp = $('.block-weather-temperature-value');\n                                var tempData = '<p>' + farhValue + '°<span>F</span></p>';\n                                $('.block-weather-temperature-value').attr('data-value', farhValue);\n                                $('.block-weather-temperature-value').attr('data-action', 'fahrenheit');\n                                temp.html(tempData);\n                            } else {\n                                // CHANGE TO CELSIUS\n                                var celcValue = Math.floor((parseInt(tempValue) - 32) * 5 / 9);\n                                var temp = $('.block-weather-temperature-value');\n                                var tempData = '<p>' + celcValue + '°<span>C</span></p>';\n                                $('.block-weather-temperature-value').attr('data-value', celcValue);\n                                $('.block-weather-temperature-value').attr('data-action', 'celsius');\n                                temp.html(tempData);\n                            }\n                        }\n                    });\n                });\n            },\n            weatherInfo: function(s, enabledOption, weatherKey) {\n                // CHECK IF BROWSER SUPPORTS GEOLOCATION\n                if ('geolocation' in navigator) {\n                    navigator.geolocation.getCurrentPosition(setPosition, showError);\n                } else {\n                    weather.weatherError(s[0]);\n                }\n\n                // SET USER'S POSITION\n                function setPosition(position) {\n                    let latitude = position.coords.latitude;\n                    let longitude = position.coords.longitude;\n                    if (enabledOption === 1 && weatherKey.length) {\n                        weather.openWeather(s, weatherKey, latitude, longitude);\n                    } else if (enabledOption === 2 && weatherKey.length) {\n                        weather.accuWeather(s, weatherKey, latitude, longitude);\n                    } else {\n                        var errorMsg = s[1];\n                        weather.weatherError(errorMsg);\n                    }\n                }\n\n                // SHOW ERROR WHEN THERE IS AN ISSUE WITH GEOLOCATION SERVICE\n                function showError(error) {\n                    var errorMsg = `${error.message}`;\n                    weather.weatherError(errorMsg);\n                }\n            },\n            weatherError: function(error) {\n                var context = {\n                    weathererror: `<p> ${error} </p>`,\n                    weathericon: M.util.image_url('unknown', 'block_weather'),\n                    weathervalue: '-',\n                    weatherattr: '-'\n                };\n                templates.render('block_weather/weather_info', context).then(function(html, js) {\n                    var tag = $('#weather-container');\n                    tag.html(html);\n                }).fail(notification.exception);\n            },\n            openWeather: function(s, weatherKey, latitude, longitude) {\n                let api = `https://api.openweathermap.org/data/2.5/weather?lat=${latitude}&lon=${longitude}&appid=${weatherKey}`;\n                fetch(api)\n                    .then(function(response) {\n                        return response.json();\n                    })\n                    .then(function(data) {\n                        if (data.cod === 200) {\n                            var context = {\n                                weathervalue: Math.floor(data.main.temp - 273),\n                                weatherdesc: data.weather[0].description,\n                                weatherattr: 'celsius',\n                                weathericon: M.util.image_url(data.weather[0].icon, 'block_weather'),\n                                weatherlocation: data.name + ', ' + data.sys.country\n                            };\n                            templates.render('block_weather/weather_info', context).then(function(html, js) {\n                                var tag = $('#weather-container');\n                                tag.html(html);\n                            }).fail(notification.exception);\n                        } else {\n                            var errorMsg = s[1];\n                            weather.weatherError(errorMsg);\n                        }\n                    });\n            },\n            accuWeather : function(s, weatherKey, latitude, longitude) {\n                let locationKey = `https://dataservice.accuweather.com/locations/v1/cities/geoposition/search?apikey=${weatherKey}&q=${latitude}%2C${longitude}&language=en-us&details=false&toplevel=false`;\n                console.log(locationKey);\n                fetch(locationKey)\n                    .then(function(response) {\n                        return response.json();\n                    })\n                    .then(function(data) {\n                        if (data.Key.length) {\n                            console.log(data.Key.length);\n                            let api = `https://dataservice.accuweather.com/currentconditions/v1/${data.Key}?apikey=${weatherKey}&language=en-us&details=false`;\n                            console.log(api);\n                            fetch(api)\n                                .then(function(response) {\n                                    return response.json();\n                                })\n                                .then(function(weatherData) {\n                                    if (weatherData[0].WeatherText.length) {\n                                        var context = {\n                                            weathervalue: weatherData[0].Temperature.Metric.Value,\n                                            weatherdesc: weatherData[0].WeatherText,\n                                            weatherattr: 'celsius',\n                                            weathericon: M.util.image_url(weatherData[0].WeatherIcon, 'block_weather'),\n                                            weatherlocation: data.EnglishName + ', ' + data.AdministrativeArea.EnglishName\n                                        };\n                                        console.log(context);\n                                        templates.render('block_weather/weather_info', context).then(function(html, js) {\n                                            var tag = $('#weather-container');\n                                            tag.html(html);\n                                        }).fail(notification.exception);\n                                    } else {\n                                        var errorMsg = s[1];\n                                        weather.weatherError(errorMsg);\n                                    }\n                                });\n                        } else {\n                            var errorMsg = s[1];\n                            weather.weatherError(errorMsg);\n                        }\n                    });\n\n            }\n        };\n        return weather;\n    });\n"],"file":"block_weather.min.js"}